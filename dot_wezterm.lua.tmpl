local wezterm = require("wezterm")
local config = wezterm.config_builder()
local act = wezterm.action

----------------------------------------------------------------
-- 1. ç”± chezmoi å‹•æ…‹æ³¨å…¥å°ˆæ¡ˆæª” (å„ªé›…é™ç´š)
----------------------------------------------------------------
-- æ³¨æ„ï¼šé€™è£¡çš„ .weztermProject ä¾†è‡ªæ–¼ä½ çš„ .chezmoi.toml.tmpl
local ok, projects = pcall(require, "{{ .weztermProject }}")
local local_workspaces = {}
if ok and projects then
    local_workspaces = projects.workspaces or {}
    config.launch_menu = projects.launch_menu or {}
else
    wezterm.log_warn("{{ .weztermProject }} module not found, using empty config")
end

----------------------------------------------------------------
-- 2. åŸºç¤å¤–è§€èˆ‡ç³»çµ±è¨­å®š
----------------------------------------------------------------
config.initial_cols = 120
config.initial_rows = 28
config.font_size = 12
config.color_scheme = "Ocean (dark) (terminal.sexy)"
config.default_prog = { "pwsh.exe" } -- é è¨­ä½¿ç”¨ PowerShell

config.font = wezterm.font_with_fallback({
    "Maple Mono Normal CN",
    "FiraCode Nerd Font Mono ",
})

-- è¨­å®š Leader Key (Alt + b)
config.leader = { key = "b", mods = "ALT", timeout_milliseconds = 1000 }

----------------------------------------------------------------
-- 3. å¿«æ·éµè¨­å®š (å«è¶…ç´šå…¥å£)
----------------------------------------------------------------
config.keys = {
    -- [é€šç”¨] é–‹å•Ÿç´”æ·¨æ–°åˆ†é 
    { key = "w", mods = "ALT", action = act.SpawnCommandInNewTab({ cwd = "~" }) },

    -- [é€šç”¨] é–‹å•Ÿå–®ä¸€ç›®éŒ„æ¸…å–® (åŸæœ¬çš„ Launcher)
    { key = "l", mods = "ALT", action = act.ShowLauncher },

    -- [æ ¸å¿ƒ] è¶…ç´šå…¥å£ (Alt + 9)ï¼šè‡ªå‹•ç”Ÿæˆå°ˆæ¡ˆå¥—é¤é¸å–®
    {
        key = "9",
        mods = "ALT",
        action = act.InputSelector({
            title = "ğŸš€ å·¥ä½œæ¨¡å¼: {{ .weztermProject }} (" .. wezterm.hostname() .. ")",
            choices = (function()
                local c = {}
                -- è‡ªå‹•å¾å°ˆæ¡ˆæª”ä¸­æå–å¥—é¤æ¨™ç±¤
                for i, ws in ipairs(local_workspaces) do
                    table.insert(c, { label = ws.label, id = tostring(i) })
                end
                -- åŠ å…¥é–‹å•Ÿå–®ä¸€æ¸…å–®çš„é¸é …
                table.insert(c, { label = "ğŸ“ å±•é–‹å–®ä¸€å°ˆæ¡ˆåˆ—è¡¨", id = "menu" })
                return c
            end)(),
            action = wezterm.action_callback(function(window, pane, id, label)
                if not id then return end

                if id == "menu" then
                    -- å‘¼å« launch_menu é …ç›®
                    window:perform_action(act.ShowLauncherArgs({ flags = "LAUNCH_MENU_ITEMS" }), pane)
                else
                    -- åŸ·è¡Œå°æ‡‰å¥—é¤çš„å¤šåˆ†é å•Ÿå‹•
                    local idx = tonumber(id)
                    local ws = local_workspaces[idx]
                    local mux_window = window:mux_window()
                    
                    for i, t_info in ipairs(ws.tabs) do
                        local new_tab, _, _ = mux_window:spawn_tab({ cwd = t_info.cwd })
                        new_tab:set_title(t_info.title)
                        -- å•Ÿå‹•æœ€å¾Œä¸€å€‹åˆ†é æ™‚å°‡ç„¦é»ç§»éå»
                        if i == #ws.tabs then new_tab:activate() end
                    end
                end
            end),
        }),
    },

    -- [Leader] æ‰‹å‹•åˆ†å‰²èˆ‡é—œé–‰
    { key = "c", mods = "LEADER", action = act.SpawnTab("CurrentPaneDomain") },
    { key = "h", mods = "LEADER", action = act.SplitPane({ direction = "Right", size = { Percent = 50 } }) },
    { key = "v", mods = "LEADER", action = act.SplitPane({ direction = "Down", size = { Percent = 50 } }) },
    { key = "x", mods = "LEADER", action = act.CloseCurrentPane({ confirm = true }) },
    { key = "q", mods = "LEADER", action = act.CloseCurrentTab({ confirm = true }) },

    -- [å°è¦½] åˆ†å‰²è¦–çª—åˆ‡æ› (Alt + æ–¹å‘éµ)
    { key = "LeftArrow",  mods = "ALT", action = act.ActivatePaneDirection("Left") },
    { key = "RightArrow", mods = "ALT", action = act.ActivatePaneDirection("Right") },
    { key = "UpArrow",    mods = "ALT", action = act.ActivatePaneDirection("Up") },
    { key = "DownArrow",  mods = "ALT", action = act.ActivatePaneDirection("Down") },

    -- [æ¯”ä¾‹] èª¿æ•´è¦–çª—å¤§å° (Leader + æ–¹å‘éµ)
    { key = "LeftArrow",  mods = "LEADER", action = act.AdjustPaneSize({ "Left", 10 }) },
    { key = "RightArrow", mods = "LEADER", action = act.AdjustPaneSize({ "Right", 10 }) },
    { key = "UpArrow",    mods = "LEADER", action = act.AdjustPaneSize({ "Up", 10 }) },
    { key = "DownArrow",  mods = "LEADER", action = act.AdjustPaneSize({ "Down", 10 }) },

    -- [åˆ‡æ›åˆ†é ] (Alt + { / })
    { key = "{", mods = "ALT", action = act.ActivateTabRelative(-1) },
    { key = "}", mods = "ALT", action = act.ActivateTabRelative(1) },
}

----------------------------------------------------------------
-- 4. å¿«é€Ÿåˆ‡æ›åˆ†é  (Ctrl + Alt + 1~8)
----------------------------------------------------------------
for i = 1, 8 do
    table.insert(config.keys, {
        key = tostring(i),
        mods = "CTRL|ALT",
        action = act.ActivateTab(i - 1),
    })
end

return config
